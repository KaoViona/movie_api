<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é›»å½±éƒ¨è½æ ¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex justify-center py-10 font-sans">

  <div class="w-11/12 max-w-6xl bg-white shadow-xl rounded-xl p-8">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">ğŸ¬ é›»å½±éƒ¨è½æ ¼</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- å·¦å´ï¼šé›»å½±æ¸…å–® -->
      <div class="md:col-span-1 space-y-4" id="postList"></div>

      <!-- å³å´ï¼šé›»å½±å…§å®¹å€ -->
      <div id="articleContent" class="md:col-span-2 border rounded-lg p-6 bg-gray-50 relative">
        <img id="moviePoster" src="" alt="é›»å½±æµ·å ±" class="w-full mb-4 rounded-lg shadow">
        <h2 class="text-2xl font-bold mb-2" id="postTitle"></h2>
        <p class="text-sm text-gray-600 mb-4" id="postDirector"></p>
        <p class="text-gray-700 leading-relaxed mb-4" id="postContent"></p>

        <!-- Like & Comment æŒ‰éˆ• -->
        <div class="flex items-center space-x-6 mb-6">
          <button id="likeBtn" class="flex items-center space-x-2 text-blue-600 hover:text-blue-800">
            <span>ğŸ‘</span><span>Like</span><span id="likeCount">0</span>
          </button>
          <button id="commentBtn" class="flex items-center space-x-2 text-gray-700 hover:text-gray-900">
            <span>ğŸ’¬</span><span>ç•™è¨€</span><span id="commentCount">0</span>
          </button>
        </div>

        <!-- ç•™è¨€è¼¸å…¥å€ -->
        <div id="commentInputArea" class="mt-4 hidden">
          <textarea id="commentText" class="w-full border rounded-lg p-2 mb-2" rows="2" placeholder="å¯«ä¸‹ä½ çš„ç•™è¨€..."></textarea>
          <button id="sendComment" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700">é€å‡º</button>
        </div>

        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div id="commentList" class="mt-6 space-y-2"></div>
      </div>
    </div>
  </div>

  <script>
    let posts = {};
    let currentPostId = 1;

    // å–å¾—å¾Œç«¯è²¼æ–‡è³‡æ–™
    async function fetchPosts() {
      try {
        const res = await fetch("http://127.0.0.1:8000/posts");
        posts = await res.json();
        renderPostList();
        renderPost(currentPostId);
      } catch (err) {
        alert("ç„¡æ³•å–å¾—è²¼æ–‡è³‡æ–™ï¼Œè«‹ç¢ºèªå¾Œç«¯æœ‰å•Ÿå‹•");
      }
    }

    // é¡¯ç¤ºå·¦å´è²¼æ–‡åˆ—è¡¨
    function renderPostList() {
      const listDiv = document.getElementById("postList");
      listDiv.innerHTML = "";
      for (const id in posts) {
        const post = posts[id];
        const card = document.createElement("div");
        card.className = "article-card border rounded-lg p-4 hover:bg-gray-50 cursor-pointer";
        card.innerHTML = `
          <h2 class="font-bold text-lg">${post.title}</h2>
          <p class="text-sm text-gray-600">å°æ¼”ï¼š${post.director}</p>
          <p class="text-gray-700 mt-2">${post.content.slice(0, 20)}...</p>
          <p class="text-right text-blue-600 text-sm">é–±è®€æ›´å¤š â†’</p>
        `;
        card.addEventListener("click", () => {
          currentPostId = id;
          renderPost(id);
        });
        listDiv.appendChild(card);
      }
    }

    // é¡¯ç¤ºå³å´æ–‡ç« å…§å®¹
    function renderPost(id) {
      const post = posts[id];
      document.getElementById("moviePoster").src = post.poster;
      document.getElementById("postTitle").textContent = post.title;
      document.getElementById("postDirector").textContent = `å°æ¼”ï¼š${post.director}`;
      document.getElementById("postContent").textContent = post.content;
      document.getElementById("likeCount").textContent = post.likes;
      document.getElementById("commentCount").textContent = post.comments.length;
      renderComments(post.comments);
    }

    function renderComments(commentArray) {
      const list = document.getElementById("commentList");
      list.innerHTML = "";
      commentArray.forEach(c => {
        const div = document.createElement("div");
        div.className = "border rounded-lg p-2 bg-white flex items-start space-x-2";
        div.innerHTML = `<div class="text-gray-400 text-xl">ğŸ‘¤</div><p class="text-gray-800">${c.user}: ${c.text}</p>`;
        list.appendChild(div);
      });
      document.getElementById("commentCount").textContent = commentArray.length;
    }

    // Like æŒ‰éˆ•
    document.getElementById("likeBtn").addEventListener("click", async () => {
      try {
        const res = await fetch(`http://127.0.0.1:8000/posts/${currentPostId}/like`, { method: "POST" });
        const data = await res.json();
        posts[currentPostId].likes = data.likes;
        document.getElementById("likeCount").textContent = data.likes;
      } catch {
        alert("æŒ‰è®šå¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœ‰å•Ÿå‹•");
      }
    });

    // Comment æŒ‰éˆ•
    document.getElementById("commentBtn").addEventListener("click", () => {
      document.getElementById("commentInputArea").classList.toggle("hidden");
    });

    // ç•™è¨€é€å‡º
    document.getElementById("sendComment").addEventListener("click", async () => {
      const text = document.getElementById("commentText").value.trim();
      if (!text) return;
      try {
        const res = await fetch(`http://127.0.0.1:8000/posts/${currentPostId}/comment`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user: "K", text })
        });
        const data = await res.json();
        posts[currentPostId].comments = data.comments;
        renderComments(data.comments);
        document.getElementById("commentText").value = "";
      } catch {
        alert("ç•™è¨€å¤±æ•—ï¼Œè«‹ç¢ºèªå¾Œç«¯æœ‰å•Ÿå‹•");
      }
    });

    window.onload = fetchPosts;
  </script>
</body>
</html>
